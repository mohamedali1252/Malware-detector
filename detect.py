import os
import subprocess
while True:
	os.system("top -b -n 20 -d 1.0 > output.txt")
	os.system(''' awk '$8=="R" {print $1, $10;} ' output.txt > output2.txt''')
	os.system("sort -k1 output2.txt > output3.txt")
	f = open("output3.txt", "r")
	dict={}
	pid = []
	for x in f:
		y = x.split()
		if y[0] not in dict.keys():
		        dict[y[0]]=list(map(float, y[1:]))
		else:
		        dict[y[0]].extend(list(map(float, y[1:])))
		        
	for i in dict:
		maxim = max(dict[i])
		minim = min(dict[i])
		diff = maxim - minim
		if diff > 5.0:
			print("Process",int(i),"may be malicious")
			pid.append(int(i))
	if len(pid) == 1:
		os.kill(pid[0],9)

	#for z in range(len(pid)):
	#	ppid = pid[z]
	#	command = "pmap -XX -q " + ppid +" > pmp.txt"
	#	gh = os.system(command)
	#	line = subprocess.check_output("grep -n -e 'heap' pmp.txt | cut -d : -f 1 > pmpoo.txt",shell = True)
	#	#line = open("pmpoo.txt", "r")
	#	print(line)
	#	#line = line.split(":")
	#	#print(line)
	#os.kill(pid[0],9)
	os.system("rm output.txt output2.txt output3.txt")