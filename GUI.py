#!/usr/bin/python3

from Tkinter import *
import os
import subprocess
import platform





def Logic():
	comman = "top -b -n 20 -d 1.0 > output.txt"
	os.system("top -b -n 20 -d 1.0 > output.txt")
	os.system(''' awk '$8=="R" {print $1, $10;} ' output.txt > output2.txt''')
	os.system("sort -k1 output2.txt > output3.txt")
	f = open("output3.txt", "r")
	dict={}
	pid = []
	for x in f:
		y = x.split()
		if y[0] not in dict.keys():
			dict[y[0]]=list(map(float, y[1:]))
		else:
			dict[y[0]].extend(list(map(float, y[1:])))			
	for i in dict:
		maxim = max(dict[i])
		minim = min(dict[i])
		diff = maxim - minim
		if diff > 5.0:
			print("Process",int(i),"may be malicious")
			pid.append(int(i))
	if len(pid) == 1:
		os.kill(pid[0],9)

		#for z in range(len(pid)):
		#	ppid = pid[z]
		#	command = "pmap -XX -q " + ppid +" > pmp.txt"
		#	gh = os.system(command)
		#	line = subprocess.check_output("grep -n -e 'heap' pmp.txt | cut -d : -f 1 > pmpoo.txt",shell = True)
		#	#line = open("pmpoo.txt", "r")
		#	print(line)
		#	#line = line.split(":")
		#	#print(line)
		#os.kill(pid[0],9)
	os.system("rm output.txt output2.txt output3.txt")



vaa = "GUI "
root = Tk()
root.title("Malware Detector")

root.grid_rowconfigure(0, weight=1)
root.grid_columnconfigure(0, weight=1)



w = root.winfo_reqwidth()
h = root.winfo_reqheight()
ws = root.winfo_screenwidth()
hs = root.winfo_screenheight()
x = (ws/2) - (w/2)
y = (hs/2) - (h/2)
root.geometry('+%d+%d' % (x, y))

topFrame = Frame(root)
topFrame.pack()



bottomFrame = Frame(root)
bottomFrame.pack(side=BOTTOM)


#clicked1 = StringVar()
#clicked1.set("20")

#clicked2 = StringVar()
#clicked2.set("1.0")

#def haveVal():
#	no = clicked1.get()
#	dela = clicked2.get()


#op1 = OptionMenu(topFrame,clicked1,"10","20","30","40","50","60")
#op2 = OptionMenu(topFrame,clicked2,"1.0","2.0","3.0","4.0","5.0","6.0")

#myButton = Button(topFrame,text="Enter",command=haveVal)



main1 = Label(topFrame,text="BEFORE",fg="red")
main2 = Label(bottomFrame,text="AFTER")


l1=Label(topFrame,text="PID")
l2=Label(bottomFrame,text="PID")

l3=Label(topFrame,text="Name")
l4=Label(bottomFrame,text="Name")

w1 = Text(topFrame,fg="red",bg="white")
w2 = Text(bottomFrame,fg="black",bg="white")

w3 = Text(topFrame,fg="red",bg="white")
w4 = Text(bottomFrame,fg="black",bg="white")



scrollbar1 = Scrollbar(topFrame, orient='vertical', command=w1.yview)
scrollbar2 = Scrollbar(bottomFrame, orient='vertical', command=w2.yview)

scrollbar3 = Scrollbar(topFrame, orient='vertical', command=w3.yview)
scrollbar4 = Scrollbar(bottomFrame, orient='vertical', command=w4.yview)



first = ['awk', ' $8=="S" {print $1,$12}']
p1 = subprocess.Popen(["top","-b","-n","1","-d","1.0"], stdout=subprocess.PIPE)
p2 = subprocess.check_output(first, stdin=p1.stdout)
p3 = p2.split()
for i in range(2,len(p3),2):
	w1.insert(INSERT,p3[i]+"\n")
for i in range(3,len(p3),2):
	w3.insert(INSERT,p3[i]+"\n")

Logic()

first = ['awk', ' $8=="S" {print $1,$12}']
p1 = subprocess.Popen(["top","-b","-n","1","-d","1.0"], stdout=subprocess.PIPE)
p2 = subprocess.check_output(first, stdin=p1.stdout)
p3 = p2.split()
for i in range(2,len(p3),2):
	w2.insert(INSERT,p3[i]+"\n")
for i in range(3,len(p3),2):
	w4.insert(INSERT,p3[i]+"\n")

w1.config(state=DISABLED)
w2.config(state=DISABLED)
w3.config(state=DISABLED)
w4.config(state=DISABLED)

main1.grid(row=0,column=0,columnspan=5)
main2.grid(row=5,column=0,columnspan=5)

l1.grid(row=1,column=0,columnspan=2)
l2.grid(row=6,column=0,columnspan=2)
l3.grid(row=1,column=3,columnspan=3)
l4.grid(row=6,column=3,columnspan=3)

w1.grid(row=2,column=0,rowspan=5,columnspan=1)
w2.grid(row=7,column=0,rowspan=5,columnspan=2)
w3.grid(row=2,column=3,rowspan=5,columnspan=1)
w4.grid(row=7,column=3,rowspan=5,columnspan=2)

scrollbar1.grid(row=2,column=2,sticky='ns',rowspan=5,)
scrollbar2.grid(row=7,column=2,sticky='ns',rowspan=5)
scrollbar3.grid(row=2,column=7,sticky='ns',rowspan=5,)
scrollbar4.grid(row=7,column=7,sticky='ns',rowspan=5)


w1['yscrollcommand'] = scrollbar1.set
w2['yscrollcommand'] = scrollbar2.set
w3['yscrollcommand'] = scrollbar3.set
w4['yscrollcommand'] = scrollbar4.set


root.mainloop()
